<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Problems and Solutions in Applied Statistics (2nd ed) - 38&nbsp; Drawing maps with Leaflet</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./mds.html" rel="next">
<link href="./kmeans-cluster.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<script src="site_libs/jquery-1.12.4/jquery.min.js"></script>
<link href="site_libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="site_libs/leaflet-1.3.1/leaflet.js"></script>
<link href="site_libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="site_libs/proj4-2.6.2/proj4.min.js"></script>
<script src="site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="site_libs/leaflet-binding-2.1.2/leaflet.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./maps.html"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Drawing maps with Leaflet</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Problems and Solutions in Applied Statistics (2nd ed)</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting_used.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting used to R and R Studio</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reading-in.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Reading in data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./making-graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Drawing graphs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-summaries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data exploration</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./working-with-dataframes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Working with dataframes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./one-sample-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">One-sample inference</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./two-sample-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Two-sample inference</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./power.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Power and sample size</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sign.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">The sign test</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mood-median.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Mood median test</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matched-pairs-sign.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Matched pairs t and sign test</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./normal-quantile.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Normal quantile plots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis-of-variance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Analysis of variance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reports.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Writing reports</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Learning to code</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dandruff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Treating dandruff</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidying-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Tidying data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./simple-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Simple regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiple-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Multiple regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-categorical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Regression with categorical variables</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dates-and-times.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Dates and times</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Functions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vector-matrix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Vector and matrix algebra</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bootstrap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">The Bootstrap</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stan.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Bayesian Statistics with Stan</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-revisited.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Regression revisited</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logistic-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Logistic regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ordinal-response.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Logistic regression with ordinal response</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nominal-response.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Logistic regression with nominal response</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./survival-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Survival analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anova-revisited.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Analysis of variance revisited</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ancova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Analysis of covariance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./manova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Multivariate analysis of variance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./repeated-measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Repeated measures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discriminant-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Discriminant analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cluster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Hierarchical cluster analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kmeans-cluster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">K-means cluster analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./maps.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Drawing maps with Leaflet</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mds.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Multidimensional Scaling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Principal Components</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Factor Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./loglin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Frequency table analysis</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#making-a-map-of-wisconsin" id="toc-making-a-map-of-wisconsin" class="nav-link active" data-scroll-target="#making-a-map-of-wisconsin"><span class="header-section-number">38.1</span> Making a map of Wisconsin</a></li>
  <li><a href="#the-cross-city-line" id="toc-the-cross-city-line" class="nav-link" data-scroll-target="#the-cross-city-line"><span class="header-section-number">38.2</span> The Cross-City Line</a></li>
  <li><a href="#the-brain-of-a-cat-revisited" id="toc-the-brain-of-a-cat-revisited" class="nav-link" data-scroll-target="#the-brain-of-a-cat-revisited"><span class="header-section-number">38.3</span> The brain of a cat, revisited</a></li>
  <li><a href="#making-a-map-of-wisconsin-1" id="toc-making-a-map-of-wisconsin-1" class="nav-link" data-scroll-target="#making-a-map-of-wisconsin-1"><span class="header-section-number">38.4</span> Making a map of Wisconsin</a></li>
  <li><a href="#the-cross-city-line-1" id="toc-the-cross-city-line-1" class="nav-link" data-scroll-target="#the-cross-city-line-1"><span class="header-section-number">38.5</span> The Cross-City Line</a></li>
  <li><a href="#the-brain-of-a-cat-revisited-1" id="toc-the-brain-of-a-cat-revisited-1" class="nav-link" data-scroll-target="#the-brain-of-a-cat-revisited-1"><span class="header-section-number">38.6</span> The brain of a cat, revisited</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Drawing maps with Leaflet</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Packages for this chapter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggbiplot)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="making-a-map-of-wisconsin" class="level2" data-number="38.1">
<h2 data-number="38.1" class="anchored" data-anchor-id="making-a-map-of-wisconsin"><span class="header-section-number">38.1</span> Making a map of Wisconsin</h2>
<p>The file <a href="http://ritsokiguess.site/datafiles/wisconsin.txt">link</a> contains the road distances (in miles) between 12 cities in Wisconsin and neighbouring states. We are going to try to draw a map of the area using Leaflet.</p>
<ol type="a">
<li><p>Read in the data, displaying the data that you read in.</p></li>
<li><p>Make a dataframe containing the names of the locations (get rid of the columns containing distances), and add a column of the abbreviations of the states they are in. All of them are in Wisconsin (WI), except for the last three: Dubuque is in Iowa (IA), St.&nbsp;Paul is in Minnesota (MN) and Chicago is in Illinois (IL).</p></li>
<li><p>Create a new column in which the abbreviation for the state is glued on to the end of each <code>location</code>, separated by a space.</p></li>
<li><p>Look up the latitudes and longitudes of these twelve places.</p></li>
<li><p>Obtain a Leaflet map of the area containing these twelve cities.</p></li>
</ol>
</section>
<section id="the-cross-city-line" class="level2" data-number="38.2">
<h2 data-number="38.2" class="anchored" data-anchor-id="the-cross-city-line"><span class="header-section-number">38.2</span> The Cross-City Line</h2>
<p>When I went to university (in Birmingham, England, a long time ago), I was very excited because I would be travelling to campus by train. My journey was on the Cross-City Line, a metro-type service with lots of stops short distances apart, but run in those days by diesel trains (the electrification came later).</p>
<p>A list of the stations on the line is in <a href="http://ritsokiguess.site/datafiles/cross-city.csv">http://ritsokiguess.site/datafiles/cross-city.csv</a>. There is one column in the data file, called <code>station</code>. We are going to draw a map of these.</p>
<ol type="a">
<li><p>Read in and display (some of) the station names.</p></li>
<li><p>In preparation for geocoding, create a second column in the dataframe that consists of the station names with “station UK” on the end. (This is to improve the chances of the geocoder finding the actual railway station.)</p></li>
<li><p>Look up the longitudes and latitudes of all the stations, organizing your dataframe so that they are visible.</p></li>
<li><p>Make a Leaflet map of the stations. Use circle markers or the “pin” markers as you prefer.</p></li>
<li><p>Zoom in to see whether the geocoding did indeed find each of the stations. Comment briefly on what you find.</p></li>
</ol>
</section>
<section id="the-brain-of-a-cat-revisited" class="level2" data-number="38.3">
<h2 data-number="38.3" class="anchored" data-anchor-id="the-brain-of-a-cat-revisited"><span class="header-section-number">38.3</span> The brain of a cat, revisited</h2>
<p>Earlier, we looked at an ethics study that had to do with a fictional brain of a fictional cat. I said there was actually a <em>town</em> called Catbrain. It’s in England, near Bristol, and seems to be home to a street of car dealerships.</p>
<ol type="a">
<li><p>Find the latitude and longitude of “Catbrain UK” (though I don’t think there are any others).</p></li>
<li><p>Draw a map of Catbrain using Leaflet.</p></li>
<li><p>Make a dataframe containing some other British cities as well as Catbrain, and find their latitudes and longitudes.</p></li>
<li><p>Draw a map containing the places you picked.</p></li>
</ol>
<p>My solutions follow:</p>
</section>
<section id="making-a-map-of-wisconsin-1" class="level2" data-number="38.4">
<h2 data-number="38.4" class="anchored" data-anchor-id="making-a-map-of-wisconsin-1"><span class="header-section-number">38.4</span> Making a map of Wisconsin</h2>
<p>The file <a href="http://ritsokiguess.site/datafiles/wisconsin.txt">link</a> contains the road distances (in miles) between 12 cities in Wisconsin and neighbouring states. We are going to try to draw a map of the area using Leaflet.</p>
<ol type="a">
<li>Read in the data, displaying the data that you read in.</li>
</ol>
<p>Solution</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>my_url <span class="ot">&lt;-</span> <span class="st">"http://ritsokiguess.site/datafiles/wisconsin.txt"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>wisc <span class="ot">&lt;-</span> <span class="fu">read_table</span>(my_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
── Column specification ────────────────────────────────────────────────────────
cols(
  location = col_character(),
  Appleton = col_double(),
  Beloit = col_double(),
  Fort.Atkinson = col_double(),
  Madison = col_double(),
  Marshfield = col_double(),
  Milwaukee = col_double(),
  Monroe = col_double(),
  Superior = col_double(),
  Wausau = col_double(),
  Dubuque = col_double(),
  St.Paul = col_double(),
  Chicago = col_double()
)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>wisc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["Appleton"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Beloit"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Fort.Atkinson"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Madison"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Marshfield"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["Milwaukee"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["Monroe"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["Superior"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["Wausau"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["Dubuque"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["St.Paul"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["Chicago"],"name":[13],"type":["dbl"],"align":["right"]}],"data":[{"1":"Appleton","2":"0","3":"130","4":"98","5":"102","6":"103","7":"100","8":"149","9":"315","10":"91","11":"196","12":"257","13":"186"},{"1":"Beloit","2":"130","3":"0","4":"33","5":"50","6":"185","7":"73","8":"33","9":"377","10":"186","11":"94","12":"304","13":"97"},{"1":"Fort.Atkinson","2":"98","3":"33","4":"0","5":"36","6":"164","7":"54","8":"58","9":"359","10":"166","11":"119","12":"287","13":"113"},{"1":"Madison","2":"102","3":"50","4":"36","5":"0","6":"138","7":"77","8":"47","9":"330","10":"139","11":"95","12":"258","13":"146"},{"1":"Marshfield","2":"103","3":"185","4":"164","5":"138","6":"0","7":"184","8":"170","9":"219","10":"45","11":"186","12":"161","13":"276"},{"1":"Milwaukee","2":"100","3":"73","4":"54","5":"77","6":"184","7":"0","8":"107","9":"394","10":"181","11":"168","12":"322","13":"92"},{"1":"Monroe","2":"149","3":"33","4":"58","5":"47","6":"170","7":"107","8":"0","9":"362","10":"186","11":"61","12":"289","13":"130"},{"1":"Superior","2":"315","3":"377","4":"359","5":"330","6":"219","7":"394","8":"362","9":"0","10":"223","11":"351","12":"162","13":"467"},{"1":"Wausau","2":"91","3":"186","4":"166","5":"139","6":"45","7":"181","8":"186","9":"223","10":"0","11":"215","12":"175","13":"275"},{"1":"Dubuque","2":"196","3":"94","4":"119","5":"95","6":"186","7":"168","8":"61","9":"351","10":"215","11":"0","12":"274","13":"184"},{"1":"St.Paul","2":"257","3":"304","4":"287","5":"258","6":"161","7":"322","8":"289","9":"162","10":"175","11":"274","12":"0","13":"395"},{"1":"Chicago","2":"186","3":"97","4":"113","5":"146","6":"276","7":"93","8":"130","9":"467","10":"275","11":"184","12":"395","13":"0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The first time I did this, I had a blank line on the end of the data file, so I had a blank <code>location</code> and missing values for all the distances for it. I tidied that up before sharing the file with you, though.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" type="a">
<li>Make a dataframe containing the names of the locations (get rid of the columns containing distances), and add a column of the abbreviations of the states they are in. All of them are in Wisconsin (WI), except for the last three: Dubuque is in Iowa (IA), St.&nbsp;Paul is in Minnesota (MN) and Chicago is in Illinois (IL).</li>
</ol>
<p>Solution</p>
<p>There seems to be a bit of base R attached to this, however you do it. I am going to create a dataframe pretending they are all in Wisconsin, and then fix it up afterwards:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>wisc <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">where</span>(is.numeric)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"WI"</span>) <span class="ot">-&gt;</span> wisc</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>wisc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI"},{"1":"Beloit","2":"WI"},{"1":"Fort.Atkinson","2":"WI"},{"1":"Madison","2":"WI"},{"1":"Marshfield","2":"WI"},{"1":"Milwaukee","2":"WI"},{"1":"Monroe","2":"WI"},{"1":"Superior","2":"WI"},{"1":"Wausau","2":"WI"},{"1":"Dubuque","2":"WI"},{"1":"St.Paul","2":"WI"},{"1":"Chicago","2":"WI"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>(I checked that in this question I didn’t need the road distances for anything, so I saved it back into the original dataframe. Also, the <code>select</code> is unnecessarily fancy: I could have just selected the <code>location</code> column, but this one says “don’t select any of the columns that are numeric”.)</p>
<p>Now we have to fix up the states of the last three places, which is where the base R seems to come in (but see the Extra):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>wisc<span class="sc">$</span>state[<span class="dv">10</span>] <span class="ot">&lt;-</span> <span class="st">"IA"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>wisc<span class="sc">$</span>state[<span class="dv">11</span>] <span class="ot">&lt;-</span> <span class="st">"MN"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>wisc<span class="sc">$</span>state[<span class="dv">12</span>] <span class="ot">&lt;-</span> <span class="st">"IL"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>wisc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI"},{"1":"Beloit","2":"WI"},{"1":"Fort.Atkinson","2":"WI"},{"1":"Madison","2":"WI"},{"1":"Marshfield","2":"WI"},{"1":"Milwaukee","2":"WI"},{"1":"Monroe","2":"WI"},{"1":"Superior","2":"WI"},{"1":"Wausau","2":"WI"},{"1":"Dubuque","2":"IA"},{"1":"St.Paul","2":"MN"},{"1":"Chicago","2":"IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The states of the last three locations are now correct.</p>
<p>Extra: I didn’t know about the following until literally just now, but there is a <code>tidyverse</code> way to do this as well (that may look familiar to those of you that know about SQL). Let’s start by pretending again that everything is in Wisconsin:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>wisc <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"WI"</span>) <span class="ot">-&gt;</span> wisc2</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>wisc2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI"},{"1":"Beloit","2":"WI"},{"1":"Fort.Atkinson","2":"WI"},{"1":"Madison","2":"WI"},{"1":"Marshfield","2":"WI"},{"1":"Milwaukee","2":"WI"},{"1":"Monroe","2":"WI"},{"1":"Superior","2":"WI"},{"1":"Wausau","2":"WI"},{"1":"Dubuque","2":"WI"},{"1":"St.Paul","2":"WI"},{"1":"Chicago","2":"WI"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>and then change the ones that need changing. What you do is to make a little dataframe of the ones that need changing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>changes <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>location, <span class="sc">~</span>state,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Dubuque"</span>, <span class="st">"IA"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"St.Paul"</span>, <span class="st">"MN"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Chicago"</span>, <span class="st">"IL"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>changes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Dubuque","2":"IA"},{"1":"St.Paul","2":"MN"},{"1":"Chicago","2":"IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Note that the columns in here have <em>exactly</em> the same names as the ones in the original dataframe where everything was in Wisconsin.</p>
<p>I did this by copy-pasting the city names whose states needed changing out of the display of my <code>wisc2</code>. You might think that a left join is what we need now, and it almost is. Note that I want to match the locations but <em>not</em> the states:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>wisc2 <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(changes, <span class="at">by =</span> <span class="st">"location"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state.x"],"name":[2],"type":["chr"],"align":["left"]},{"label":["state.y"],"name":[3],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI","3":"NA"},{"1":"Beloit","2":"WI","3":"NA"},{"1":"Fort.Atkinson","2":"WI","3":"NA"},{"1":"Madison","2":"WI","3":"NA"},{"1":"Marshfield","2":"WI","3":"NA"},{"1":"Milwaukee","2":"WI","3":"NA"},{"1":"Monroe","2":"WI","3":"NA"},{"1":"Superior","2":"WI","3":"NA"},{"1":"Wausau","2":"WI","3":"NA"},{"1":"Dubuque","2":"WI","3":"IA"},{"1":"St.Paul","2":"WI","3":"MN"},{"1":"Chicago","2":"WI","3":"IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>and the story here is that if <code>state.y</code> has a value, use that, otherwise use the value in <code>state.x</code>. This can even be done: there is a function <code>coalesce</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> that will do exactly that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>wisc2 <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(changes, <span class="at">by =</span> <span class="st">"location"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state=</span><span class="fu">coalesce</span>(state.y, state.x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state.x"],"name":[2],"type":["chr"],"align":["left"]},{"label":["state.y"],"name":[3],"type":["chr"],"align":["left"]},{"label":["state"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI","3":"NA","4":"WI"},{"1":"Beloit","2":"WI","3":"NA","4":"WI"},{"1":"Fort.Atkinson","2":"WI","3":"NA","4":"WI"},{"1":"Madison","2":"WI","3":"NA","4":"WI"},{"1":"Marshfield","2":"WI","3":"NA","4":"WI"},{"1":"Milwaukee","2":"WI","3":"NA","4":"WI"},{"1":"Monroe","2":"WI","3":"NA","4":"WI"},{"1":"Superior","2":"WI","3":"NA","4":"WI"},{"1":"Wausau","2":"WI","3":"NA","4":"WI"},{"1":"Dubuque","2":"WI","3":"IA","4":"IA"},{"1":"St.Paul","2":"WI","3":"MN","4":"MN"},{"1":"Chicago","2":"WI","3":"IL","4":"IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The idea behind <code>coalesce</code> is that you give it a list of columns, and the first one of those that is <em>not missing</em> gives its value to the new column. So I feed it <code>state.y</code> <em>first</em>, and then <code>state.x</code>, and the new <code>state</code> contains the right things. (Can you explain what happens if you do it the other way around?)</p>
<p>But, there is a better way. Let’s go back to our all-Wisconsin dataframe:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>wisc2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI"},{"1":"Beloit","2":"WI"},{"1":"Fort.Atkinson","2":"WI"},{"1":"Madison","2":"WI"},{"1":"Marshfield","2":"WI"},{"1":"Milwaukee","2":"WI"},{"1":"Monroe","2":"WI"},{"1":"Superior","2":"WI"},{"1":"Wausau","2":"WI"},{"1":"Dubuque","2":"WI"},{"1":"St.Paul","2":"WI"},{"1":"Chicago","2":"WI"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>and our dataframe of corrections to make:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>changes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Dubuque","2":"IA"},{"1":"St.Paul","2":"MN"},{"1":"Chicago","2":"IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>We can make those changes in one step, thus:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>wisc2 <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rows_update</span>(changes) <span class="ot">-&gt;</span> wisc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Matching, by = "location"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>wisc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI"},{"1":"Beloit","2":"WI"},{"1":"Fort.Atkinson","2":"WI"},{"1":"Madison","2":"WI"},{"1":"Marshfield","2":"WI"},{"1":"Milwaukee","2":"WI"},{"1":"Monroe","2":"WI"},{"1":"Superior","2":"WI"},{"1":"Wausau","2":"WI"},{"1":"Dubuque","2":"IA"},{"1":"St.Paul","2":"MN"},{"1":"Chicago","2":"IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>This works because the <em>first</em> column of <code>changes</code>, namely <code>location</code>, is the one that is looked up in <code>wisc2</code>. (<code>rows_update</code> has a <code>by</code> in the same way that <code>left_join</code> does if you want to change this.) So all three locations in <code>changes</code> are looked up in <code>wisc2</code>, and any that match have their <code>state</code> changed to the one in <code>changes</code>.</p>
<p>In database terms, the <code>location</code> is known as a “key” column. That means that each city appears <em>once only</em> in the column, and so the replacements in <code>wisc</code> are only happening once. To a statistician, <code>location</code> is an “identifier variable”, identifying the individuals in the dataset. Unless you are doing something like repeated measures, each individual will only give you one measurement, but even then, if you have wide format, the identifier variables will still only appear once.</p>
<p>Magic. Now that I have learned about this, I will be using it a lot.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" type="a">
<li>Create a new column in which the abbreviation for the state is glued on to the end of each <code>location</code>, separated by a space.</li>
</ol>
<p>Solution</p>
<p>A couple of ways: a literal gluing, using <code>paste</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>wisc <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lookup =</span> <span class="fu">paste</span>(location, state))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]},{"label":["lookup"],"name":[3],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI","3":"Appleton WI"},{"1":"Beloit","2":"WI","3":"Beloit WI"},{"1":"Fort.Atkinson","2":"WI","3":"Fort.Atkinson WI"},{"1":"Madison","2":"WI","3":"Madison WI"},{"1":"Marshfield","2":"WI","3":"Marshfield WI"},{"1":"Milwaukee","2":"WI","3":"Milwaukee WI"},{"1":"Monroe","2":"WI","3":"Monroe WI"},{"1":"Superior","2":"WI","3":"Superior WI"},{"1":"Wausau","2":"WI","3":"Wausau WI"},{"1":"Dubuque","2":"IA","3":"Dubuque IA"},{"1":"St.Paul","2":"MN","3":"St.Paul MN"},{"1":"Chicago","2":"IL","3":"Chicago IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>or the same idea using <code>str_c</code> from <code>stringr</code> (part of the tidyverse), only this time you have to supply the space yourself:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>wisc <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lookup =</span> <span class="fu">str_c</span>(location, <span class="st">" "</span>, state))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["location"],"name":[1],"type":["chr"],"align":["left"]},{"label":["state"],"name":[2],"type":["chr"],"align":["left"]},{"label":["lookup"],"name":[3],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton","2":"WI","3":"Appleton WI"},{"1":"Beloit","2":"WI","3":"Beloit WI"},{"1":"Fort.Atkinson","2":"WI","3":"Fort.Atkinson WI"},{"1":"Madison","2":"WI","3":"Madison WI"},{"1":"Marshfield","2":"WI","3":"Marshfield WI"},{"1":"Milwaukee","2":"WI","3":"Milwaukee WI"},{"1":"Monroe","2":"WI","3":"Monroe WI"},{"1":"Superior","2":"WI","3":"Superior WI"},{"1":"Wausau","2":"WI","3":"Wausau WI"},{"1":"Dubuque","2":"IA","3":"Dubuque IA"},{"1":"St.Paul","2":"MN","3":"St.Paul MN"},{"1":"Chicago","2":"IL","3":"Chicago IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>or a way you might have forgotten, using <code>unite</code> (which is the inverse of <code>separate</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>wisc <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unite</span>(lookup, <span class="fu">c</span>(location, state), <span class="at">sep =</span> <span class="st">" "</span>) <span class="ot">-&gt;</span> wisc</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>wisc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["lookup"],"name":[1],"type":["chr"],"align":["left"]}],"data":[{"1":"Appleton WI"},{"1":"Beloit WI"},{"1":"Fort.Atkinson WI"},{"1":"Madison WI"},{"1":"Marshfield WI"},{"1":"Milwaukee WI"},{"1":"Monroe WI"},{"1":"Superior WI"},{"1":"Wausau WI"},{"1":"Dubuque IA"},{"1":"St.Paul MN"},{"1":"Chicago IL"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>This last one is my favourite, because it gets rid of the two constituent columns <code>location</code> and <code>state</code> that we don’t need any more. The syntax is the name of the new column, a vector of columns to unite together, and (optionally) what to separate the joined-together values with. The default for that is an underscore, but here we want a space because that’s what the geocoder (coming up) expects.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" type="a">
<li>Look up the latitudes and longitudes of these twelve places.</li>
</ol>
<p>Solution</p>
<p>This is geocoding, with the disentangling afterwards that is (I hope) becoming familiar:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>wisc <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ll =</span> <span class="fu">list</span>(<span class="fu">geocode_OSM</span>(lookup))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(ll) <span class="sc">%&gt;%</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(coords) <span class="ot">-&gt;</span> wisc</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>wisc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["lookup"],"name":[1],"type":["chr"],"align":["left"]},{"label":["query"],"name":[2],"type":["chr"],"align":["left"]},{"label":["x"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["bbox"],"name":[5],"type":["list"],"align":["right"]}],"data":[{"1":"Appleton WI","2":"Appleton WI","3":"-88.40697","4":"44.26140","5":"<bbox>"},{"1":"Beloit WI","2":"Beloit WI","3":"-89.03178","4":"42.50833","5":"<bbox>"},{"1":"Fort.Atkinson WI","2":"Fort.Atkinson WI","3":"-88.83705","4":"42.92889","5":"<bbox>"},{"1":"Madison WI","2":"Madison WI","3":"-89.38376","4":"43.07476","5":"<bbox>"},{"1":"Marshfield WI","2":"Marshfield WI","3":"-90.17180","4":"44.66885","5":"<bbox>"},{"1":"Milwaukee WI","2":"Milwaukee WI","3":"-87.92250","4":"43.03499","5":"<bbox>"},{"1":"Monroe WI","2":"Monroe WI","3":"-90.63973","4":"43.94168","5":"<bbox>"},{"1":"Superior WI","2":"Superior WI","3":"-92.10408","4":"46.72077","5":"<bbox>"},{"1":"Wausau WI","2":"Wausau WI","3":"-89.62982","4":"44.95960","5":"<bbox>"},{"1":"Dubuque IA","2":"Dubuque IA","3":"-90.66480","4":"42.50062","5":"<bbox>"},{"1":"St.Paul MN","2":"St.Paul MN","3":"-93.09310","4":"44.94975","5":"<bbox>"},{"1":"Chicago IL","2":"Chicago IL","3":"-87.62442","4":"41.87556","5":"<bbox>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Yes, I forgot the <code>rowwise</code> as well the first time.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" type="a">
<li>Obtain a Leaflet map of the area containing these twelve cities.</li>
</ol>
<p>Solution</p>
<p>The usual:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> wisc) <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addCircleMarkers</span>(<span class="at">lng =</span> <span class="sc">~</span>x, <span class="at">lat =</span> <span class="sc">~</span>y) <span class="ot">-&gt;</span> locs</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>locs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-73ba83e4a7c22d17f752" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-73ba83e4a7c22d17f752">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addCircleMarkers","args":[[44.2613967,42.5083272,42.9288944,43.074761,44.6688524,43.0349931,43.9416755,46.7207737,44.9596017,42.5006243,44.9497487,41.8755616],[-88.4069744,-89.031784,-88.83705089999999,-89.3837613,-90.1717987,-87.92249700000001,-90.6397264,-92.10407960000001,-89.62982390000001,-90.6647985,-93.0931028,-87.6244212],10,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[41.8755616,46.7207737],"lng":[-93.0931028,-87.6244212]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The nice thing about this map is that you can play with it: zoom it (using the plus/minus on the map or your mouse wheel), or move it around by clicking and dragging. To identify the cities: well, the big ones are obvious, and you can zoom in to identify the others. (You have to zoom in quite a long way to find Monroe, and the geocoder seems to have found its airport, which is not actually in the city.)</p>
<p>I like identifying the cities with circles, but there are other possibilities, such as “icon markers” that look like Google map pins:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> wisc) <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMarkers</span>(<span class="at">lng =</span> <span class="sc">~</span>x, <span class="at">lat =</span> <span class="sc">~</span>y) <span class="ot">-&gt;</span> locs</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>locs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-bbe3da0cd7c9c058cfbe" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-bbe3da0cd7c9c058cfbe">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addMarkers","args":[[44.2613967,42.5083272,42.9288944,43.074761,44.6688524,43.0349931,43.9416755,46.7207737,44.9596017,42.5006243,44.9497487,41.8755616],[-88.4069744,-89.031784,-88.83705089999999,-89.3837613,-90.1717987,-87.92249700000001,-90.6397264,-92.10407960000001,-89.62982390000001,-90.6647985,-93.0931028,-87.6244212],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[41.8755616,46.7207737],"lng":[-93.0931028,-87.6244212]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>You can even attach text to the markers that appears when you click on them, but that’s farther than I would go here.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</section>
<section id="the-cross-city-line-1" class="level2" data-number="38.5">
<h2 data-number="38.5" class="anchored" data-anchor-id="the-cross-city-line-1"><span class="header-section-number">38.5</span> The Cross-City Line</h2>
<p>When I went to university (in Birmingham, England, a long time ago), I was very excited because I would be travelling to campus by train. My journey was on the Cross-City Line, a metro-type service with lots of stops short distances apart, but run in those days by diesel trains (the electrification came later).</p>
<p>A list of the stations on the line is in <a href="http://ritsokiguess.site/datafiles/cross-city.csv">http://ritsokiguess.site/datafiles/cross-city.csv</a>. There is one column in the data file, called <code>station</code>. We are going to draw a map of these.</p>
<ol type="a">
<li>Read in and display (some of) the station names.</li>
</ol>
<p>Solution</p>
<p>Nothing terribly unexpected here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(my_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 24 Columns: 1
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): station

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>stations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["station"],"name":[1],"type":["chr"],"align":["left"]}],"data":[{"1":"Redditch"},{"1":"Alvechurch"},{"1":"Barnt Green"},{"1":"Longbridge"},{"1":"Northfield"},{"1":"King's Norton"},{"1":"Bournville"},{"1":"Selly Oak"},{"1":"Birmingham University"},{"1":"Five Ways"},{"1":"Birmingham New Street"},{"1":"Duddeston"},{"1":"Aston"},{"1":"Gravelly Hill"},{"1":"Erdington"},{"1":"Chester Road"},{"1":"Wylde Green"},{"1":"Sutton Coldfield"},{"1":"Four Oaks"},{"1":"Butler's Lane"},{"1":"Blake Street"},{"1":"Shenstone"},{"1":"Lichfield City"},{"1":"Lichfield Trent Valley"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" type="a">
<li>In preparation for geocoding, create a second column in the dataframe that consists of the station names with “station UK” on the end. (This is to improve the chances of the geocoder finding the actual railway station.)</li>
</ol>
<p>Solution</p>
<p>I wrote this back into the original dataframe. Create a new one if you prefer:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>stations <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">longname =</span> <span class="fu">str_c</span>(station, <span class="st">" station UK"</span>)) <span class="ot">-&gt;</span> stations</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>stations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["station"],"name":[1],"type":["chr"],"align":["left"]},{"label":["longname"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Redditch","2":"Redditch station UK"},{"1":"Alvechurch","2":"Alvechurch station UK"},{"1":"Barnt Green","2":"Barnt Green station UK"},{"1":"Longbridge","2":"Longbridge station UK"},{"1":"Northfield","2":"Northfield station UK"},{"1":"King's Norton","2":"King's Norton station UK"},{"1":"Bournville","2":"Bournville station UK"},{"1":"Selly Oak","2":"Selly Oak station UK"},{"1":"Birmingham University","2":"Birmingham University station UK"},{"1":"Five Ways","2":"Five Ways station UK"},{"1":"Birmingham New Street","2":"Birmingham New Street station UK"},{"1":"Duddeston","2":"Duddeston station UK"},{"1":"Aston","2":"Aston station UK"},{"1":"Gravelly Hill","2":"Gravelly Hill station UK"},{"1":"Erdington","2":"Erdington station UK"},{"1":"Chester Road","2":"Chester Road station UK"},{"1":"Wylde Green","2":"Wylde Green station UK"},{"1":"Sutton Coldfield","2":"Sutton Coldfield station UK"},{"1":"Four Oaks","2":"Four Oaks station UK"},{"1":"Butler's Lane","2":"Butler's Lane station UK"},{"1":"Blake Street","2":"Blake Street station UK"},{"1":"Shenstone","2":"Shenstone station UK"},{"1":"Lichfield City","2":"Lichfield City station UK"},{"1":"Lichfield Trent Valley","2":"Lichfield Trent Valley station UK"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" type="a">
<li>Look up the longitudes and latitudes of all the stations, organizing your dataframe so that they are visible.</li>
</ol>
<p>Solution</p>
<p>Two steps: the first is to do the geocoding, and the second is to disentangle what comes back.</p>
<p>First, then:</p>
<div class="cell" data-hash="maps_cache/html/cross-city-4_e82499c550c2a9a5a0c78aa3cb92837b">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>stations <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ll =</span> <span class="fu">list</span>(<span class="fu">geocode_OSM</span>(longname))) <span class="ot">-&gt;</span> stations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No results found for "King's Norton station UK".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>No results found for "Butler's Lane station UK".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>stations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["station"],"name":[1],"type":["chr"],"align":["left"]},{"label":["longname"],"name":[2],"type":["chr"],"align":["left"]},{"label":["ll"],"name":[3],"type":["list"],"align":["right"]}],"data":[{"1":"Redditch","2":"Redditch station UK","3":"<named list [3]>"},{"1":"Alvechurch","2":"Alvechurch station UK","3":"<named list [3]>"},{"1":"Barnt Green","2":"Barnt Green station UK","3":"<named list [3]>"},{"1":"Longbridge","2":"Longbridge station UK","3":"<named list [3]>"},{"1":"Northfield","2":"Northfield station UK","3":"<named list [3]>"},{"1":"King's Norton","2":"King's Norton station UK","3":"<NULL>"},{"1":"Bournville","2":"Bournville station UK","3":"<named list [3]>"},{"1":"Selly Oak","2":"Selly Oak station UK","3":"<named list [3]>"},{"1":"Birmingham University","2":"Birmingham University station UK","3":"<named list [3]>"},{"1":"Five Ways","2":"Five Ways station UK","3":"<named list [3]>"},{"1":"Birmingham New Street","2":"Birmingham New Street station UK","3":"<named list [3]>"},{"1":"Duddeston","2":"Duddeston station UK","3":"<named list [3]>"},{"1":"Aston","2":"Aston station UK","3":"<named list [3]>"},{"1":"Gravelly Hill","2":"Gravelly Hill station UK","3":"<named list [3]>"},{"1":"Erdington","2":"Erdington station UK","3":"<named list [3]>"},{"1":"Chester Road","2":"Chester Road station UK","3":"<named list [3]>"},{"1":"Wylde Green","2":"Wylde Green station UK","3":"<named list [3]>"},{"1":"Sutton Coldfield","2":"Sutton Coldfield station UK","3":"<named list [3]>"},{"1":"Four Oaks","2":"Four Oaks station UK","3":"<named list [3]>"},{"1":"Butler's Lane","2":"Butler's Lane station UK","3":"<NULL>"},{"1":"Blake Street","2":"Blake Street station UK","3":"<named list [3]>"},{"1":"Shenstone","2":"Shenstone station UK","3":"<named list [3]>"},{"1":"Lichfield City","2":"Lichfield City station UK","3":"<named list [3]>"},{"1":"Lichfield Trent Valley","2":"Lichfield Trent Valley station UK","3":"<named list [3]>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The longitudes and latitudes are hidden in the list-column that I called <code>ll</code>, so the second step is to get them out:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>stations <span class="sc">%&gt;%</span> <span class="fu">unnest_wider</span>(ll) <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(coords) <span class="ot">-&gt;</span> stations</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>stations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["station"],"name":[1],"type":["chr"],"align":["left"]},{"label":["longname"],"name":[2],"type":["chr"],"align":["left"]},{"label":["query"],"name":[3],"type":["chr"],"align":["left"]},{"label":["x"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["bbox"],"name":[6],"type":["list"],"align":["right"]}],"data":[{"1":"Redditch","2":"Redditch station UK","3":"Redditch station UK","4":"-1.945609","5":"52.30638","6":"<bbox>"},{"1":"Alvechurch","2":"Alvechurch station UK","3":"Alvechurch station UK","4":"-1.967988","5":"52.34683","6":"<bbox>"},{"1":"Barnt Green","2":"Barnt Green station UK","3":"Barnt Green station UK","4":"-1.992500","5":"52.36097","6":"<bbox>"},{"1":"Longbridge","2":"Longbridge station UK","3":"Longbridge station UK","4":"-1.981076","5":"52.39625","6":"<bbox>"},{"1":"Northfield","2":"Northfield station UK","3":"Northfield station UK","4":"-1.965125","5":"52.40830","6":"<bbox>"},{"1":"King's Norton","2":"King's Norton station UK","3":"NA","4":"NA","5":"NA","6":"<NULL>"},{"1":"Bournville","2":"Bournville station UK","3":"Bournville station UK","4":"-1.950100","5":"52.42931","6":"<bbox>"},{"1":"Selly Oak","2":"Selly Oak station UK","3":"Selly Oak station UK","4":"-1.935591","5":"52.44186","6":"<bbox>"},{"1":"Birmingham University","2":"Birmingham University station UK","3":"Birmingham University station UK","4":"-1.938284","5":"52.45118","6":"<bbox>"},{"1":"Five Ways","2":"Five Ways station UK","3":"Five Ways station UK","4":"-1.911762","5":"52.47122","6":"<bbox>"},{"1":"Birmingham New Street","2":"Birmingham New Street station UK","3":"Birmingham New Street station UK","4":"-1.898694","5":"52.47765","6":"<bbox>"},{"1":"Duddeston","2":"Duddeston station UK","3":"Duddeston station UK","4":"-1.871281","5":"52.48865","6":"<bbox>"},{"1":"Aston","2":"Aston station UK","3":"Aston station UK","4":"-1.088457","5":"51.48475","6":"<bbox>"},{"1":"Gravelly Hill","2":"Gravelly Hill station UK","3":"Gravelly Hill station UK","4":"-1.852708","5":"52.51539","6":"<bbox>"},{"1":"Erdington","2":"Erdington station UK","3":"Erdington station UK","4":"-1.835808","5":"52.52623","6":"<bbox>"},{"1":"Chester Road","2":"Chester Road station UK","3":"Chester Road station UK","4":"-2.879530","5":"53.19675","6":"<bbox>"},{"1":"Wylde Green","2":"Wylde Green station UK","3":"Wylde Green station UK","4":"-1.831425","5":"52.54563","6":"<bbox>"},{"1":"Sutton Coldfield","2":"Sutton Coldfield station UK","3":"Sutton Coldfield station UK","4":"-1.825255","5":"52.56472","6":"<bbox>"},{"1":"Four Oaks","2":"Four Oaks station UK","3":"Four Oaks station UK","4":"-1.828031","5":"52.57955","6":"<bbox>"},{"1":"Butler's Lane","2":"Butler's Lane station UK","3":"NA","4":"NA","5":"NA","6":"<NULL>"},{"1":"Blake Street","2":"Blake Street station UK","3":"Blake Street station UK","4":"-1.844660","5":"52.60438","6":"<bbox>"},{"1":"Shenstone","2":"Shenstone station UK","3":"Shenstone station UK","4":"-1.845452","5":"52.64073","6":"<bbox>"},{"1":"Lichfield City","2":"Lichfield City station UK","3":"Lichfield City station UK","4":"-1.825125","5":"52.68022","6":"<bbox>"},{"1":"Lichfield Trent Valley","2":"Lichfield Trent Valley station UK","3":"Lichfield Trent Valley station UK","4":"-1.801351","5":"52.68718","6":"<bbox>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The two <code>unnest_wider</code>s are because the longitudes and latitudes are hidden inside a thing called <code>coords</code> which is itself nested within <code>ll</code>. Do the first <code>unnest_wider</code>, and see what you have. This will tell you that you need to do another one.</p>
<p>The values seem reasonable; this is the UK, most of which is slightly west of the Greenwich meridian, and the latitudes look sensible given that the UK is north of southern Ontario.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" type="a">
<li>Make a Leaflet map of the stations. Use circle markers or the “pin” markers as you prefer.</li>
</ol>
<p>Solution</p>
<p>I used the pin markers (with <code>addMarkers</code>), though <code>addCircleMarkers</code> is as good. The code for drawing the map is always the same; the work here is in setting up the geocoding:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> stations) <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMarkers</span>(<span class="at">lng =</span> <span class="sc">~</span>x, <span class="at">lat =</span> <span class="sc">~</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in validateCoords(lng, lat, funcName): Data contains 2 rows with either
missing or invalid lat/lon values and will be ignored</code></pre>
</div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-7ac02990ede920010d33" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-7ac02990ede920010d33">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addMarkers","args":[[52.3063807,52.3468339,52.3609702,52.3962549,52.4082951,null,52.4293084,52.4418625,52.4511815,52.4712194,52.4776459,52.4886501,51.48475005,52.5153876,52.52622865,53.1967494,52.545628,52.5647207,52.5795454,null,52.6043776,52.6407269,52.6802201,52.6871811],[-1.9456089,-1.9679877,-1.9924997,-1.9810763,-1.9651246,null,-1.950100399067727,-1.9355913,-1.9382838,-1.9117618,-1.898694,-1.871281295548654,-1.088456993298687,-1.8527077,-1.835808436566283,-2.8795296,-1.8314247,-1.8252548,-1.8280314,null,-1.8446597,-1.845452230927924,-1.8251247,-1.801350617141852],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[51.48475005,53.1967494],"lng":[-2.8795296,-1.088456993298687]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>You might find that some of the markers are off a straight line through Birmingham. In these cases, the geocoder found a different place with (apparently) the same name, or a name that was close enough to similar. This seems to be different each time you run it, so you can try again.</p>
<p>This (mostly) seems to extend across the city of Birmingham, as it should. There are quite a lot of stations, so the pins overlap each other. Zoom in to see them in a bit more detail, or zoom out to orient yourself if your UK geography needs some work.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="5" type="a">
<li>Zoom in to see whether the geocoding did indeed find each of the stations. Comment briefly on what you find.</li>
</ol>
<p>Solution</p>
<p>The stations go south to north, so the most southerly one you find should be Redditch and the most northerly is Lichfield Trent Valley.</p>
<p>If you zoom in enough, you’ll see where the railway line goes (a grey line). The points seem to be mainly close to it. But if you zoom in a bit more, some of the pins are right on the railway, and some of them are a bit off, because the geocoder found the centre of the place (or something else named after the place) rather than its railway station. For example, when I did it, Gravelly Hill station was right where it should be, but Aston was not.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>Extra: <code>geocode_OSM</code> uses a free geocoder called Nominatim. This has some options. The defaults are to return only the first “hit”, and to return just the coordinates and the “bounding box”. These can be changed. Let’s see what we can find for Aston:</p>
<div class="cell" data-hash="maps_cache/html/cross-city-7_daba76b3973982fd61cf049ab6e30413">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">where =</span> <span class="st">"Aston UK"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">info =</span> <span class="fu">list</span>(<span class="fu">geocode_OSM</span>(where, <span class="at">return.first.only =</span> <span class="cn">FALSE</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">details =</span> <span class="cn">TRUE</span>))) <span class="ot">-&gt;</span> d</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>d         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["where"],"name":[1],"type":["chr"],"align":["left"]},{"label":["info"],"name":[2],"type":["list"],"align":["right"]}],"data":[{"1":"Aston UK","2":"<list [10]>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>There are now 10 things returned. Let’s unnest this and see what we have:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> <span class="fu">unnest</span>(info) <span class="sc">%&gt;%</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["where"],"name":[1],"type":["chr"],"align":["left"]},{"label":["query"],"name":[2],"type":["chr"],"align":["left"]},{"label":["coords"],"name":[3],"type":["list"],"align":["right"]},{"label":["bbox"],"name":[4],"type":["list"],"align":["right"]},{"label":["place_id"],"name":[5],"type":["chr"],"align":["left"]},{"label":["osm_type"],"name":[6],"type":["chr"],"align":["left"]},{"label":["osm_id"],"name":[7],"type":["chr"],"align":["left"]},{"label":["place_rank"],"name":[8],"type":["chr"],"align":["left"]},{"label":["display_name"],"name":[9],"type":["chr"],"align":["left"]},{"label":["class"],"name":[10],"type":["chr"],"align":["left"]},{"label":["type"],"name":[11],"type":["chr"],"align":["left"]},{"label":["importance"],"name":[12],"type":["chr"],"align":["left"]},{"label":["icon"],"name":[13],"type":["chr"],"align":["left"]}],"data":[{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"8905138","6":"node","7":"966630237","8":"18","9":"Aston, Birmingham, West Midlands Combined Authority, England, B6 5PL, United Kingdom","10":"place","11":"town","12":"0.51410998224359","13":"https://nominatim.openstreetmap.org/ui/mapicons/poi_place_town.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"298308314","6":"relation","7":"947997","8":"20","9":"Aston, Hope, High Peak, Derbyshire, England, United Kingdom","10":"boundary","11":"administrative","12":"0.46050193638341","13":"https://nominatim.openstreetmap.org/ui/mapicons/poi_boundary_administrative.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"123608495","6":"way","7":"76128761","8":"30","9":"St. Peter & St. Paul, Aston, Witton Lane, Aston, Birmingham, West Midlands Combined Authority, England, B6 6QA, United Kingdom","10":"amenity","11":"place_of_worship","12":"0.45389213702575","13":"https://nominatim.openstreetmap.org/ui/mapicons/place_of_worship_unknown3.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"298278221","6":"relation","7":"1440416","8":"20","9":"Aston, Cheshire West and Chester, England, United Kingdom","10":"boundary","11":"administrative","12":"0.44596057896493","13":"https://nominatim.openstreetmap.org/ui/mapicons/poi_boundary_administrative.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"64147308","6":"node","7":"5920221964","8":"30","9":"Aston, Lovers Walk, Aston, Birmingham, West Midlands Combined Authority, England, B6 7PR, United Kingdom","10":"railway","11":"station","12":"0.44157598227638","13":"https://nominatim.openstreetmap.org/ui/mapicons/transport_train_station2.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"3767374","6":"node","7":"487080921","8":"19","9":"Aston, Flintshire, Cymru / Wales, CH5 1UR, United Kingdom","10":"place","11":"village","12":"0.44129130556068","13":"https://nominatim.openstreetmap.org/ui/mapicons/poi_place_village.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"298603241","6":"relation","7":"3594185","8":"20","9":"Aston, East Hertfordshire, Hertfordshire, England, United Kingdom","10":"boundary","11":"administrative","12":"0.430735418475","13":"https://nominatim.openstreetmap.org/ui/mapicons/poi_boundary_administrative.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"111407","6":"node","7":"26127809","8":"19","9":"Aston, West Oxfordshire, Oxfordshire, England, OX18 2DL, United Kingdom","10":"place","11":"village","12":"0.42689306175332","13":"https://nominatim.openstreetmap.org/ui/mapicons/poi_place_village.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"15390598","6":"node","7":"1709823466","8":"19","9":"Aston, Cheshire East, England, CW5 8DH, United Kingdom","10":"place","11":"village","12":"0.38501","13":"https://nominatim.openstreetmap.org/ui/mapicons/poi_place_village.p.20.png"},{"1":"Aston UK","2":"Aston UK","3":"<dbl [2]>","4":"<bbox>","5":"347759746","6":"node","7":"337820108","8":"19","9":"Aston, Shropshire, England, SY4 5JH, United Kingdom","10":"place","11":"village","12":"0.38501","13":"https://nominatim.openstreetmap.org/ui/mapicons/poi_place_village.p.20.png"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>There are 10 locations it found matching “Aston UK”, and for each of those there is the information you see, a total of 12 columns’ worth in addition to the name of the place we are looking up. Perhaps the most interesting are the columns <code>class</code> and <code>type</code> near the end (keep scrolling right):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> <span class="fu">unnest</span>(info) <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(info) <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(where, class, type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["where"],"name":[1],"type":["chr"],"align":["left"]},{"label":["class"],"name":[2],"type":["chr"],"align":["left"]},{"label":["type"],"name":[3],"type":["chr"],"align":["left"]}],"data":[{"1":"Aston UK","2":"place","3":"town"},{"1":"Aston UK","2":"boundary","3":"administrative"},{"1":"Aston UK","2":"amenity","3":"place_of_worship"},{"1":"Aston UK","2":"boundary","3":"administrative"},{"1":"Aston UK","2":"railway","3":"station"},{"1":"Aston UK","2":"place","3":"village"},{"1":"Aston UK","2":"boundary","3":"administrative"},{"1":"Aston UK","2":"place","3":"village"},{"1":"Aston UK","2":"place","3":"village"},{"1":"Aston UK","2":"place","3":"village"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>You can see which one is the railway station.</p>
<p>This makes me think that with sufficient patience we could do this for all our places, and pick out the one that is the station:</p>
<div class="cell" data-hash="maps_cache/html/cross-city-10_667fe141ab2788ef9f04560e3ff0fd9b">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(my_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 24 Columns: 1
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): station

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>stations <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">longname =</span> <span class="fu">str_c</span>(station, <span class="st">" UK"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ll =</span> <span class="fu">list</span>(<span class="fu">geocode_OSM</span>(longname, </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">return.first.only =</span> <span class="cn">FALSE</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">details =</span> <span class="cn">TRUE</span>))) <span class="ot">-&gt;</span> stations2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>stations2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["station"],"name":[1],"type":["chr"],"align":["left"]},{"label":["longname"],"name":[2],"type":["chr"],"align":["left"]},{"label":["ll"],"name":[3],"type":["list"],"align":["right"]}],"data":[{"1":"Redditch","2":"Redditch UK","3":"<list [9]>"},{"1":"Alvechurch","2":"Alvechurch UK","3":"<list [3]>"},{"1":"Barnt Green","2":"Barnt Green UK","3":"<list [2]>"},{"1":"Longbridge","2":"Longbridge UK","3":"<list [9]>"},{"1":"Northfield","2":"Northfield UK","3":"<list [10]>"},{"1":"King's Norton","2":"King's Norton UK","3":"<list [2]>"},{"1":"Bournville","2":"Bournville UK","3":"<list [8]>"},{"1":"Selly Oak","2":"Selly Oak UK","3":"<list [6]>"},{"1":"Birmingham University","2":"Birmingham University UK","3":"<named list [12]>"},{"1":"Five Ways","2":"Five Ways UK","3":"<list [10]>"},{"1":"Birmingham New Street","2":"Birmingham New Street UK","3":"<list [9]>"},{"1":"Duddeston","2":"Duddeston UK","3":"<list [2]>"},{"1":"Aston","2":"Aston UK","3":"<list [10]>"},{"1":"Gravelly Hill","2":"Gravelly Hill UK","3":"<list [10]>"},{"1":"Erdington","2":"Erdington UK","3":"<list [3]>"},{"1":"Chester Road","2":"Chester Road UK","3":"<list [10]>"},{"1":"Wylde Green","2":"Wylde Green UK","3":"<list [4]>"},{"1":"Sutton Coldfield","2":"Sutton Coldfield UK","3":"<list [10]>"},{"1":"Four Oaks","2":"Four Oaks UK","3":"<list [10]>"},{"1":"Butler's Lane","2":"Butler's Lane UK","3":"<list [3]>"},{"1":"Blake Street","2":"Blake Street UK","3":"<list [10]>"},{"1":"Shenstone","2":"Shenstone UK","3":"<list [10]>"},{"1":"Lichfield City","2":"Lichfield City UK","3":"<named list [12]>"},{"1":"Lichfield Trent Valley","2":"Lichfield Trent Valley UK","3":"<list [3]>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The number in the <code>ll</code> column tells you how many things the geocoder found that match the input <code>longname</code>. One of each of these is, we hope, a railway station.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>stations2 <span class="sc">%&gt;%</span> <span class="fu">unnest</span>(ll) <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(ll, <span class="at">names_sep =</span> <span class="st">"_"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(station, ll_coords, ll_class, ll_type) <span class="sc">%&gt;%</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ll_class <span class="sc">==</span> <span class="st">"railway"</span>, ll_type <span class="sc">==</span> <span class="st">"station"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(ll_coords) <span class="ot">-&gt;</span> d</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["station"],"name":[1],"type":["chr"],"align":["left"]},{"label":["x"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["ll_class"],"name":[4],"type":["chr"],"align":["left"]},{"label":["ll_type"],"name":[5],"type":["chr"],"align":["left"]}],"data":[{"1":"Redditch","2":"-1.945609","3":"52.30638","4":"railway","5":"station"},{"1":"Alvechurch","2":"-1.967988","3":"52.34683","4":"railway","5":"station"},{"1":"Barnt Green","2":"-1.992500","3":"52.36097","4":"railway","5":"station"},{"1":"Longbridge","2":"-1.980761","3":"52.39701","4":"railway","5":"station"},{"1":"Northfield","2":"-1.965125","3":"52.40830","4":"railway","5":"station"},{"1":"Bournville","2":"-1.926668","3":"52.42739","4":"railway","5":"station"},{"1":"Selly Oak","2":"-1.935591","3":"52.44186","4":"railway","5":"station"},{"1":"Five Ways","2":"-1.913071","3":"52.47109","4":"railway","5":"station"},{"1":"Birmingham New Street","2":"-1.898694","3":"52.47765","4":"railway","5":"station"},{"1":"Duddeston","2":"-1.871281","3":"52.48849","4":"railway","5":"station"},{"1":"Aston","2":"-1.872046","3":"52.50442","4":"railway","5":"station"},{"1":"Gravelly Hill","2":"-1.852708","3":"52.51539","4":"railway","5":"station"},{"1":"Erdington","2":"-1.839225","3":"52.52857","4":"railway","5":"station"},{"1":"Chester Road","2":"-1.832458","3":"52.53579","4":"railway","5":"station"},{"1":"Wylde Green","2":"-1.831425","3":"52.54563","4":"railway","5":"station"},{"1":"Sutton Coldfield","2":"-1.825255","3":"52.56472","4":"railway","5":"station"},{"1":"Four Oaks","2":"-1.828031","3":"52.57955","4":"railway","5":"station"},{"1":"Blake Street","2":"-1.844660","3":"52.60438","4":"railway","5":"station"},{"1":"Shenstone","2":"-1.844333","3":"52.63922","4":"railway","5":"station"},{"1":"Lichfield Trent Valley","2":"-1.800131","3":"52.68696","4":"railway","5":"station"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>If you want to see how this works, run it one line at a time.</p>
<p>We almost got there. We’re missing University<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> and Lichfield City stations, but it looks as if we got the rest:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> d) <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMarkers</span>(<span class="at">lng =</span> <span class="sc">~</span>x, <span class="at">lat =</span> <span class="sc">~</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-ec6a87802dafd412139e" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-ec6a87802dafd412139e">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addMarkers","args":[[52.3063807,52.3468339,52.3609702,52.3970107,52.4082951,52.4273889,52.4418625,52.4710941,52.4776459,52.4884888,52.5044169,52.5153876,52.5285663,52.5357946,52.545628,52.5647207,52.5795454,52.6043776,52.6392159,52.6869627],[-1.9456089,-1.9679877,-1.9924997,-1.9807611,-1.9651246,-1.9266683,-1.9355913,-1.9130708,-1.898694,-1.8712807,-1.8720459,-1.8527077,-1.8392253,-1.8324576,-1.8314247,-1.8252548,-1.8280314,-1.8446597,-1.8443329,-1.8001308],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[52.3063807,52.6869627],"lng":[-1.9924997,-1.8001308]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>If you zoom in, you’ll see that the ones we got are all the actual stations, and not the area from which the station takes its name.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
</section>
<section id="the-brain-of-a-cat-revisited-1" class="level2" data-number="38.6">
<h2 data-number="38.6" class="anchored" data-anchor-id="the-brain-of-a-cat-revisited-1"><span class="header-section-number">38.6</span> The brain of a cat, revisited</h2>
<p>Earlier, we looked at an ethics study that had to do with a fictional brain of a fictional cat. I said there was actually a <em>town</em> called Catbrain. It’s in England, near Bristol, and seems to be home to a street of car dealerships.</p>
<ol type="a">
<li>Find the latitude and longitude of “Catbrain UK” (though I don’t think there are any others).</li>
</ol>
<p>Solution</p>
<p>Make sure you have these two packages loaded:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmaptools)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To find the latitude and longitude of Catbrain:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>catbrain <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">place =</span> <span class="st">"Catbrain UK"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>catbrain <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ll =</span> <span class="fu">list</span>(<span class="fu">geocode_OSM</span>(place))) <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(ll) <span class="sc">%&gt;%</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(coords) <span class="ot">-&gt;</span> catbrain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>catbrain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["place"],"name":[1],"type":["chr"],"align":["left"]},{"label":["query"],"name":[2],"type":["chr"],"align":["left"]},{"label":["x"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["bbox"],"name":[5],"type":["list"],"align":["right"]}],"data":[{"1":"Catbrain UK","2":"Catbrain UK","3":"-2.612466","4":"51.52288","5":"<bbox>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Remember that the output from <code>geocode_OSM</code> is a list, and it has in it a thing called <code>coords</code> that is the longitude and latitude together, and another thing called <code>bbox</code> that we don’t use. So we have to <code>unnest</code> <em>twice</em> to get the longitude (as <code>x</code>) and the latitude (as <code>y</code>) out for drawing in a moment.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="2" type="a">
<li>Draw a map of Catbrain using Leaflet.</li>
</ol>
<p>Solution</p>
<p>That goes this way:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> catbrain) <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addCircleMarkers</span>(<span class="at">lng =</span> <span class="sc">~</span>x, <span class="at">lat =</span> <span class="sc">~</span>y) <span class="ot">-&gt;</span> catbrain_map</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>catbrain_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-7cfabd7d2a204323e54c" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-7cfabd7d2a204323e54c">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addCircleMarkers","args":[51.5228823,-2.6124662,10,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[51.5228823,51.5228823],"lng":[-2.6124662,-2.6124662]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>There are car dealerships are along Lysander Road. Zoom in to see them. Or zoom out to see where this is. You can keep zooming out until you know where you are, using the plus and minus buttons, or your mouse wheel.</p>
<p>The name Catbrain, according to <a href="http://www.bristolpost.co.uk/news/history/name-catbrain-hill-came-825247">link</a>, means “rough stony soil”, from Middle English, and has nothing to do with cats or their brains at all.</p>
<p>Extra: I was actually surprised that this worked at all, because with only one point, how does it know what scale to draw the map? Also, unless your UK geography is really good, you won’t have any clue about exactly where this is. That’s the reason for the next part.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="3" type="a">
<li>Make a dataframe containing some other British cities as well as Catbrain, and find their latitudes and longitudes.</li>
</ol>
<p>Solution</p>
<p>I chose the cities below, mostly somewhere near Catbrain. You could fire up a Google map, zoom it out until it contains something you know, and pick some places you’ve heard of. (I happen to know British geography pretty well, so I just picked some mostly nearby places out of my head. I didn’t really want to pick London, but I figured this was the one <em>you</em> might know.)</p>
<div class="cell" data-hash="maps_cache/html/catbrain-5_b41c82d1fd1b79d35ba60211c25666d6">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>catbrain2 <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>where,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Catbrain UK"</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Bristol UK"</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Taunton UK"</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Newport UK"</span>,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Gloucester UK"</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cardiff UK"</span>,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Birmingham UK"</span>,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"London UK"</span>,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Caldicot UK"</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>catbrain2 <span class="sc">%&gt;%</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ll =</span> <span class="fu">list</span>(<span class="fu">geocode_OSM</span>(where))) <span class="sc">%&gt;%</span> </span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(ll) <span class="sc">%&gt;%</span> </span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(coords) <span class="ot">-&gt;</span> catbrain2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>catbrain2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["where"],"name":[1],"type":["chr"],"align":["left"]},{"label":["query"],"name":[2],"type":["chr"],"align":["left"]},{"label":["x"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["bbox"],"name":[5],"type":["list"],"align":["right"]}],"data":[{"1":"Catbrain UK","2":"Catbrain UK","3":"-2.612466","4":"51.52288","5":"<bbox>"},{"1":"Bristol UK","2":"Bristol UK","3":"-2.597298","4":"51.45380","5":"<bbox>"},{"1":"Taunton UK","2":"Taunton UK","3":"-3.102909","4":"51.01479","5":"<bbox>"},{"1":"Newport UK","2":"Newport UK","3":"-2.997497","4":"51.58823","5":"<bbox>"},{"1":"Gloucester UK","2":"Gloucester UK","3":"-2.245819","4":"51.86537","5":"<bbox>"},{"1":"Cardiff UK","2":"Cardiff UK","3":"-3.179193","4":"51.48165","5":"<bbox>"},{"1":"Birmingham UK","2":"Birmingham UK","3":"-1.902691","4":"52.47970","5":"<bbox>"},{"1":"London UK","2":"London UK","3":"-0.127650","4":"51.50734","5":"<bbox>"},{"1":"Caldicot UK","2":"Caldicot UK","3":"-2.751763","4":"51.59125","5":"<bbox>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The first time I did this, I forgot the <code>rowwise</code>, which we didn’t need the first time (there was only one place), but here, it causes odd problems if you omit it.</p>
<p><span class="math inline">\(\blacksquare\)</span></p>
<ol start="4" type="a">
<li>Draw a map containing the places you picked.</li>
</ol>
<p>Solution</p>
<p>The map-drawing is almost the same, just changing the dataframe:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> catbrain2) <span class="sc">%&gt;%</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addCircleMarkers</span>(<span class="at">lng =</span> <span class="sc">~</span>x, <span class="at">lat =</span> <span class="sc">~</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-d2c11645d5cb943d3119" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-d2c11645d5cb943d3119">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addCircleMarkers","args":[[51.5228823,51.4538022,51.0147895,51.5882332,51.8653705,51.4816546,52.4796992,51.5073359,51.5912466],[-2.6124662,-2.5972985,-3.1029086,-2.9974967,-2.2458192,-3.1791934,-1.9026911,-0.12765,-2.7517629],10,null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[51.0147895,52.4796992],"lng":[-3.1791934,-0.12765]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Now, if you have any sense of the geography of the UK, you know where you are. The big river (the Severn) is the border between England and Wales, so the places above and to the left of it are in Wales, including Caldicot (see question about Roman pottery).</p>
<p>You can zoom this map <em>in</em> (once you have figured out which of the circles is Catbrain) and find Lysander Road again, and also the M5 (see below).</p>
<p>More irrelevant extra: the M5 is one of the English “motorways” (like 400-series highways or US Interstates). The M5 goes from Birmingham to Exeter. You can tell that this is England because of the huge number of traffic circles, known there as “roundabouts”. One of the first things they teach you in British driving schools is how to handle roundabouts: which lane to approach them in, which (stick-shift) gear to be in, and when you’re supposed to signal where you’re going. I hope I still remember all that for when I next drive in England!</p>
<p><span class="math inline">\(\blacksquare\)</span></p>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>I knew this existed, but I couldn’t remember what it was called, which made it hard to search for. My first port of call was <code>na_if</code>, which converts values to <code>NA</code>, the opposite of what I wanted. But from its See Also I got <code>na_replace</code>, and from the See Also of that, I found out what <code>coalesce</code> does.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>If you’re a soccer fan, this Aston is what Aston Villa is named after. See if you can find the team’s stadium Villa Park on your map, which is actually closer to Witton station on another line.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The station is called just University, not Birmingham University, which makes it hard to find.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./kmeans-cluster.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">K-means cluster analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./mds.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Multidimensional Scaling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>