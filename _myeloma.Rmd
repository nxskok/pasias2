##  Multiple myeloma


 Multiple myeloma is a kind of cancer. It
forms in a plasma cell (which is a type of white blood cell). It
causes cancer cells to accumulate in the bone marrow, where they crowd
out healthy blood cells. Plasma cells make antibodies (to help fight
infections), while the cancer cells don't: they produce abnormal
proteins that can cause kidney problems. (This adapted from
[link](http://www.mayoclinic.org/diseases-conditions/multiple-myeloma/basics/definition/con-20026607).)
The variables are:



* `time`: survival time from diagnosis (months)

* `vstatus`: 0=alive, 1=dead at end of study

* `logbun`: log of BUN test score (BUN test is a test of
kidney function, not to be confused with cha siu
bao^[Barbecued pork in a bun. A staple of Chinese dim sum and  Chinese bakeries, such as Ding Dong bakery on Spadina.]).

* `hgb`: hemoglobin (at diagnosis).

* `platelet`: platelets: 1=normal, 0=abnormal (at
diagnosis).

* `age` at diagnosis, in years

* `logwbc`: log of WBC (white blood cell count, at
diagnosis)

* `frac`: fractures at diagnosis (0=absent, 1=present)

* `logpbm`: log of percent of plasma cells in bone marrow

* `protein`: proteinuria (protein in urine) at
diagnosis. Most people have very little, so a larger than normal
amount indicates illness of some kind.

* `scalc`: serum calcium at diagnosis.


The data, on 65 patients with multiple myeloma, are in
[link](http://ritsokiguess.site/datafiles/myeloma.csv). Some of the
variables are logs because they could take very large values.

There are a lot of parts here, but each part is supposed to be short.



(a) Read in the data and display (some of) the values. Confirm that
you have the right number of observations and the right variables.


Solution


The usual:

```{r myeloma-1 }
my_url <- "http://ritsokiguess.site/datafiles/myeloma.csv"
myeloma <- read_csv(my_url)
myeloma
```

     

65 observations, and all the variables listed. If you want to go
further (not necessary here), you can check that the variables
`vstatus`, `platelet` and `frac` that should be
zero and one actually *are* zero and one, at least for the values
shown (they are), and the ages look like ages (they do).

The tidyverse also offers:

```{r myeloma-2 }
glimpse(myeloma)
```

 

which gives a bit more of a picture of the values.^[Don't  confuse this with `glance` from `broom`, which gives a one-line summary of a *model*, containing things like R-squared and a test for the overall model significance.]
Or if you were
serious about checking, you could do

```{r myeloma-3 }
summary(myeloma)
```

 

which gives means and five-number summaries for each of the variables
(the numeric ones, but they all are here, even the ones coded as 0 or
1 that are really categorical).
    

$\blacksquare$

(b) Create a suitable response variable for a Cox
proportional-hazards survival model, bearing in mind that the
"event" here is death. Display your response variable, and explain
briefly what the `+` signs attached to some of the values
mean, without using a technical term.


Solution

This is really practice for the `Surv` that you are about to use in fitting a model, so it doesn't matter whether you save the results anywhere. 


Two things to consider: the survival times, here
`time`, and the indicator of the event (death), here
`vstatus` being 1. Sometimes, though not here, the column that is `vstatus` here is used to capture various types of outcome such as "lost to follow-up" (meaning, we don't know what happened to this patient) or "died of something else", and it is then important to make sure that you know which of these outcomes is the one of interest to you.


I've changed my mind on this over the years: putting the `Surv` right in the `coxph` (next part) is what I do now, because that plays best with `marginaleffects` (later), so for me this part is just practice at getting the `Surv` right:

```{r}
with(myeloma, Surv(time, vstatus == 1))
```

The values of that have a `+` by them go with
patients who were never observed to die (or were still alive at the
end of the study). There were 17 of these, listed at the end of the
data frame. Usually, these values of the response will be higher than
the others, but they weren't here. (Maybe some of these patients were
withdrawn from the study, or they joined it late.) 

$\blacksquare$

(c) What is the technical term for those patients that have a
`+` by their values for the response variable?


Solution


Censored. A quick one.
I was trying to dissuade you from using the word "censored" in
the previous part, since I wanted you to demonstrate that you
understood what it *meant*. But you should know the technical
term as well, which is why I asked you for it here.

Grading note, for when this was on an assignment: if this part and the previous one contain,
somewhere, the word "censored" *and* a clear explanation of
what "censored" means, then I don't mind what is where.
    

$\blacksquare$

(d) Fit a Cox proportional-hazards survival model predicting
your response variable from all the other variables (except for the
ones that you used to make the response variable). Display the
`summary` of your model.


Solution


The obvious way to do this is to list all the other variables on
the right side of the squiggle, but a faster way is this:

```{r myeloma-5 }
myeloma.1 <- coxph(Surv(time, vstatus == 1) ~ ., data = myeloma)
summary(myeloma.1)
```

     

The `.` in this model formula means 
"all the columns in the data frame" 
(except for those used in the response variable). I used `time` and
`vstatus` to make the response, so I had no need to exclude them explicitly.


There is of course nothing wrong with typing out all the variable
names, except that the first time you type them out, you will likely
make a typo (unless you are more careful than I usually am). 
    

$\blacksquare$

(e) In your model, which explanatory variables have a P-value less than
0.10? Fit a model containing only those and display the results.


Solution


Only `logbun` and `hgb`; the other P-values are
larger, usually much larger.
Because there are so many variables to remove, I am frightened
away from `update` here (which I would normally try to use
in this situation). I'm going to copy-and-paste my code for
`myeloma.1` and edit it:

```{r myeloma-7 }
myeloma.2 <- coxph(Surv(time, vstatus == 1) ~ logbun + hgb, data = myeloma)
summary(myeloma.2)
```

     

That's all I wanted, but you can note that `hgb` has become
significant at $\alpha=0.05$. I suspect it was somewhat correlated
with a variable that we removed, so that its value to the regression
has become clearer.
    

$\blacksquare$

(f) Do a test to compare the two models that you fit. Why do 
you prefer the second model? Explain briefly.


Solution


Comparing two models is `anova`, which also works here. The
right `test` is `Chisq`:

```{r myeloma-8 }
anova(myeloma.2, myeloma.1, test = "Chisq")
```

     

The usual logic here: this is far from significant, so the null
hypothesis (that the two models are equally good) is not rejected, so
we prefer the smaller model `myeloma.2` because it is simpler.


In case you are curious, `step` also works on models like these:

```{r myeloma-9 }
myeloma.3 <- step(myeloma.1, direction = "backward", trace = 0)
summary(myeloma.3)
```



The same model as the one we found by brute force. You can change the
value of `trace` to see the progress, but in this case it's not
very illuminating, since `<none>` and the variables we end up
keeping are always at the bottom of the list to remove.

`step` is built on `add1` and `drop1`. In this
case, `drop1` is run repeatedly and the variable with lowest
AIC is removed. We had all numeric variables in this one, but if our
model had something categorical like `treatment` with, let's
say, 4 levels, `drop1` would contemplate dropping all four of
these in one shot, the same way it works with a categorical variable
in a regression of any other kind.

    

$\blacksquare$

(g) There should be two explanatory variables left in your
model. These are both numerical variables. Find their first and
third quartiles, any way you like.


Solution


The most concise way is probably this:

```{r myeloma-10 }
quantile(myeloma$logbun)
quantile(myeloma$hgb)
```

     

So the quartiles are 1.15 and 1.57 for `logbun`, and 8.8 and
12.0 for `hgb`.

There are (at least) three other ways to do it. This is the easiest:

```{r myeloma-11 }
summary(myeloma)
```

 

from which you pick out the ones you need. Or, you `select` the
ones you need first:

```{r myeloma-12 }
myeloma %>% select(logbun, hgb) %>% summary()
```

 

The obvious `tidyverse` way is actually a bit
inelegant, because you have to calculate two things for two variables:^[Because *summarize* will only allow you to have a single-number answer.] 

```{r myeloma-13 }
myeloma %>% summarize(
  logbun.q1 = quantile(logbun, 0.25),
  logbun.q3 = quantile(logbun, 0.75),
  hgb.q1 = quantile(hgb, 0.25),
  hgb.q3 = quantile(hgb, 0.75)
)
```

Next is the tidyverse-approved way to get both quartiles for both variables at once. Use `across` to select the variables to use, and then something with a squiggle and a dot to say "do this on each of the columns selected in the `across`". If you have a cleverer way to select those two columns without naming them, go for it. Read this in English as "for each of the columns `logbun` and `hgb`, work out the first and third quantiles of it", where the dot is read as "it". This works but is not the best way:

```{r myeloma-14}
myeloma %>% 
  summarize(across(c(logbun, hgb), 
                   \(x) quantile(x, c(0.25, 0.75))))
```

The warning says that `summarize` is designed for situations where the summary is a *single* number. (The people behind `summarize` have changed their mind on this; it used to work, indeed it still does work, but "deprecated" means "one day it will stop working and our advice is to work out what to do now rather than later".) Reading the warning carefully is the right way to figure out what to do. The `tidyverse` people have put a good deal of effort into making their messages readable and helpful, so the least we can do is to repay their hard work. 

The message says to use `reframe` rather than `summarize`, so let's try that:

```{r}
myeloma %>% 
  reframe(across(c(logbun, hgb), 
                   \(x) quantile(x, c(0.25, 0.75))))
```


This works without warnings. We have lost which quartile is which, but of course the lower one must be Q1 and the higher one Q3 for each variable.^[The way, as we  have seen elsewhere, is to use `tidy(quantile)` or `enframe(quantile)`, which  produce a two-column data frame with the percentiles shown.]
    

$\blacksquare$

(h) Create a data frame containing all possible combinations
of the two quartiles for each of the two variables, and display the result.


Solution

This is `datagrid`. My best model is the one I called `y.2` (I had to scroll back a ways to find it), so:

```{r}
new <- datagrid(model = myeloma.2, logbun = c(1.14561, 1.5682), hgb = c(8.8, 12.0))
new
```


Or anything equivalent to that. 

The place you have to get to in
the end is a data frame with columns called `logbun` and
`hgb`, and the right four combinations of values. If you want
to round the `logbun` values off more, for example to two
decimals, that's fine; it won't affect the graph that's coming up.
    
In fact, for predictions, you also need some times to predict for. We'll use 10, 20, and 35, gluing those onto the end of the `datagrid`:

```{r}
new <- datagrid(model = myeloma.2, logbun = c(1.14561, 1.5682), 
                hgb = c(8.8, 12.0), time = c(10, 20, 35))
new
```


$\blacksquare$

(i) Obtain predicted survival probabilities for each of the
combinations of variables you created above. 

Solution

This is `predictions` from `marginaleffects`:

```{r}
cbind(predictions(myeloma.2, newdata = new, type = "survival")) %>% 
  select(logbun, hgb, time, estimate)
```

Despite what it says in the original question, this is not too long to look at (the old way was). For example, increasing `hgb`  increases survival probability somewhat, if you compare the same `logbun` at the same time, and increasing `logbun` for the some `hgb` decreases survival probability by a bit more.


$\blacksquare$

(j) Obtain a graph of the predicted survival curves for each
combination of your variables.


Solution

You can do this in one shot or two, but it's `plot_predictions` either way.

The one-shot version is to put both `logbun` and `hgb` in at once (with `time` first, since the predictions depend on time which goes on the $x$-axis):

```{r}
plot_predictions(myeloma.2, condition = c("time", "logbun", "hgb"), type = "survival")
```

The first thing in `condition` goes on the $x$-axis (time), the second thing is colour (the selected values of `logbun`), and the third thing is facets (the selected values of `hgb`).

If you don't like that, or don't fancy your chances of interpreting it (in a moment), do the two explanatory variables one at a time. First this:

```{r}
plot_predictions(myeloma.2, condition = c("time", "logbun"), type = "survival")
```

and then this:

```{r}
plot_predictions(myeloma.2, condition = c("time", "hgb"), type = "survival")
```

Keep the time first, to make sure it appears on the plot where it should. These two graphs leave you only one thing to compare (the colours, each time).




$\blacksquare$

(k) Is it better to have high or low values for each of the
variables in your prediction? Explain briefly.


Solution


The best survival curve is the top-right one in each case.

On the graph of `logbun`, this is the red curve, that goes with the *lowest* value of `logbun`.  So the lowest value on this variable is the best, and as `logbun` increases, the survival gets progressively worse. With `hgb`, it is the other way around: the lowest value is worst, and the highest value (pink curve) is the best.

If you prefer the one-shot graph with both explanatory variables on it:

- to assess `logbun`, pick a facet, and see which curve is best: the red one, which goes with the *lowest* `logbun` value.
- to assess `hgb`, cast your eye across the facets (along the first row and then the second) and see what is happening to the survival curves as you move from one facet to the next. These ones are moving up in their facet, so survival is improving as `hgb` increases (those numbers on the top of the facets are values of `hgb`).

Another way to think about this is to mentally compare all of those survival curves and ask which is the best out of all of them: the one for `logbun` 0.7782 (the smallest value), and `hgb` 14.6 (the largest value).

Extra 1: the conclusions from the graphs are the same as those from the `summary` table (as they should be). The coefficient of `logbun` is 1.72, positive, so that a higher value is associated with a higher hazard of death (and thus a smaller value is better). On the other hand, the coefficient of `hgb`, -0.12, is negative, so that a higher value *decreases* the hazard of death, and is thus better. You might find it confusing that things are this way around; the story is that you have to get used to it, and one way to do that is to phrase it in terms of hazard of death (or whatever the event is), and then decide whether that is good or bad.

Extra 2: for `ggplot` enthusiasts among you: when you have three variables in a `plot_predictions`, the plot uses `facet_wrap`. When you have *four* of them (as one of the plots in one of the other problems does), it uses `facet_grid`, which is the way to handle *two* extra categorical or made-categorical variables. In this case, the quantitative variables `hgb` and `logbun` have been broken up into five distinct values, although they could take any of the values in between; they have been made categorical to enable us to draw a graph.

Extra 3: the model we fitted here assumes that each variable has a one-directional effect: that is, survival is better the higher the variable's value gets (`hgb`) or the lower it gets (`logbun`), but it can't change direction. You might imagine an explanatory variable that has a "best" value: survival improves as the value increases, until it reaches the best value, and then, as it increases further, survival gets worse again. To model something like that, you might add a squared term in the variable and see whether that is significant; if it is, the relationship is curved rather than linear. An example of a variable for which that might be true is blood pressure; it is dangerous to have a blood pressure that is too high ("hypertension") or one that is too low ("hypotension").


Extra 4: Things that are tests, like `logbun`, are often set up so that
a high value is the abnormal one (so that an abnormal one will be easy
to spot). Things that are measurements, like `hgb`, might have
an ideal range, but the better value could be high or low, depending
on what is being measured.
    
$\blacksquare$




